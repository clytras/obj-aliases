const _dataAliases=function(e){var t=this;this._data=e,this._keysSplit=".",this._paramsKeyIndicator="#",this._linkMarks={root:"@",siblings:">",parents:"~"},this._customPipes={},this.get=function(e,t,s){var n=!(s instanceof Object&&"useAliases"in s)||s.useAliases,i=s instanceof Object&&"expandString"in s&&s.expandString,a=s instanceof Object&&"expandStringParams"in s?s.expandStringParams:{};1==arguments.length&&(t=void 0);var r=this.__resolve({key:e,followAliasLinks:n,expandString:i,expandStringParams:a});return r.found?r.value:t},this.$get=function(e,s){return t.get(e,s,{useAliases:!1})},this.expandString=function(e,s){return t.get(e,"",{expandString:!0,expandStringParams:s})},this.set=function(e,s,n){var i=!(n instanceof Object&&"useAliases"in n)||n.useAliases;return!!t.__resolve({key:e,setNewValue:!0,newValue:s,followAliasLinks:i}).found},this.$set=function(e,s){return t.set(e,s,{useAliases:!1})},this.__makeKey=function(){var e,t=[];for(e=0;e<arguments.length;e++){var s=arguments[e];(s||0===s)&&t.push(s)}return t.join(".")},this.merge=function(e,s,n){var i;if(!(e instanceof Object||s))throw new Error("Cant set primitive value to data root");for(i in e){var a,r=e[i];if(r instanceof Object)if(r instanceof Array)for(a=0;a<r.length;a++)t.$set(t.__makeKey(s,i,"[]"),r[a]);else t.merge(r,t.__makeKey(s,i),n);else t.$set(t.__makeKey(s,i),r)}},this.del=function(e,s){var n=!(s instanceof Object&&"useAliases"in s)||s.useAliases;return!!t.__resolve({key:e,deleteIt:!0,followAliasLinks:n}).found},this.$del=function(e){return t.del(e,{useAliases:!1})},this.has=function(e){return!(!t._data||!Object.keys(t._data).length)&&t.__resolve({key:e}).found},this.$has=function(e){return t.exists(e)},this.exists=function(e){return!(!t._data||!Object.keys(t._data).length)&&t.__resolve({key:e,followAliasLinks:!1}).found},this.setLinkMarks=function(e){"root"in e&&(t._linkMarks.root=e.root),"siblings"in e&&(t._linkMarks.siblings=e.siblings),"parents"in e&&(t._linkMarks.parents=e.parents)},this.setKeysSplit=function(e){t._keysSplit=e},this.setCustomPipes=function(e){t._customPipes=e},this.__isAliasWithArgs=function(e){return e instanceof Array&&2===e.length&&"string"==typeof e[0]&&this.__isAlias(e[0]).result},this.__isAlias=function(e){var s=new RegExp("^(["+t._linkMarks.root+t._linkMarks.siblings+t._linkMarks.parents+"])(.*)").exec(e);return{result:null!==s,type:s?s[1]:null,key:s?s[2]:null,parts:s?s[2].split(t._keysSplit):[]}},this.__parseKey=function(e){var s=new RegExp("^(["+t._linkMarks.root+t._linkMarks.siblings+t._linkMarks.parents+"]?)("+t._paramsKeyIndicator+"?)([A-z0-9-.]+)[|]?(.*)").exec(e);return{type:s[1],key:s[3],fullKey:s[1]+s[3],isParamKey:s[2]===t._paramsKeyIndicator,functions:s[4]}},this.__applyFunctions=function(e,s){if("string"==typeof s&&s.length>0){for(var n=s.split(","),i=e,a=0;a<n.length;a++){var r=n[a].toLowerCase().trim();switch(r){case"upper":i=i.toUpperCase();break;case"lower":i=i.toLowerCase();break;default:r in t._customPipes&&"function"==typeof t._customPipes[r]&&(i=t._customPipes[r](i))}}return i}return e},this.__resolve=function(e){var s,n=e.key,i="dataroot"in e?e.dataroot:null,a="setNewValue"in e&&e.setNewValue,r="deleteIt"in e&&e.deleteIt,l="newValue"in e?e.newValue:void 0,o="mustMatchFirstKey"in e&&e.mustMatchFirstKey,u=!("followAliasLinks"in e)||e.followAliasLinks,_="expandString"in e&&e.expandString,f="_expandStringParams"in e?e._expandStringParams:new _dataAliases(e.expandStringParams||{}),p=this.__parseKey(n);s=p.isParamKey&&f.has(p.key)?p.type+f.get(p.key):p.fullKey;var k=p.key.split(t._keysSplit),c=i||this._data,h=!1,y="",g=[c];if("currentPath"in e){var d=e.currentPath.split(t._keysSplit);for(var v in g=[c],d){var m=d[v];m in c&&(c=c[m],y=m,g.push(c))}}if(!_||!_||!f.has(s))for(var A=0;A<k.length;A++){var S=k[A],w=A===k.length-1,b=w?null:k[A+1];if("-"===S[0]&&/^-?\d+$/.test(S)&&(S=c.length+parseInt(S)),c instanceof Object&&S in c){if(u&&("string"==typeof c[S]||c[S]instanceof Array)){let e=c[S];this.__isAliasWithArgs(c[S])&&(e=c[S][0],f.merge(c[S][1]));var x=this.__isAlias(e);if(x.result){switch(x.type){case t._linkMarks.parents:for(var M=!1,P=null,K=g.length-2;K>=-1;K--)if((P=t.__resolve({key:x.key,dataroot:g[K],setNewValue:a,newValue:l,deleteIt:r,mustMatchFirstKey:!0,_expandStringParams:f})).found){M=!0,newValueSet=!0;break}M?(g=g.slice(0,K-1),c=P.value):h=!0;break;case t._linkMarks.siblings:case t._linkMarks.root:var j;if(x.type===t._linkMarks.siblings){var V=s.split(t._keysSplit);V.length>=2?(V.splice(V.length-1,1,x.key),j=V.join(t._keysSplit)):j=x.key}else j=x.key;var O=t.__resolve({key:j,setNewValue:a,newValue:l,deleteIt:r,_expandStringParams:f});O.found?(c=O.value,newValueSet=!0):h=!0}if(h)break;a&&(a=!1),r&&(r=!1)}else c=c[S]}else c=c[S];a&&w&&(g[g.length-1][S]instanceof Array?g[g.length-1][S].push(l):g[g.length-1][S]=l)}else{if(!a||o&&!(o&&A>0)){h=!0;break}"[]"===S?(c instanceof Array||(c=[]),w&&c.push(l)):c instanceof Array?(c.push({}),w?(c[c.length-1][S]=l,c=c[c.length-1][S]):(c[c.length-1][S]={},c=c[c.length-1][S])):(w?c[S]=l:c instanceof Object?c[S]="[]"===b?[]:{}:(c instanceof Object||(g[g.length-2][y]={},c=g[g.length-2][y]),c[S]={}),c=c[S])}y=S,g.push(c)}return h||(r?(delete g[g.length-2][y],c=null):_&&"string"==typeof c&&(c=c.replace(/\{(.*?)\}/gi,((e,n,i)=>{var r=this.__parseKey(n),l=function(e){return r.functions&&"string"==typeof e?t.__applyFunctions(e,r.functions):e},o=r.key;let u;if(r.isParamKey?(f.has(r.key)?o=f.get(r.key):f.$has(r.key)&&(o=f.$get(r.key)),u=t.__isAlias(o),u.result||(u=t.__isAlias(n))):u=t.__isAlias(n),!u.result){if(f.has(o))return l(f.get(o));var _=t.__resolve({key:o,_expandStringParams:f});return _.found?l(_.value):l(o)}switch(u.type){case t._linkMarks.parents:for(var p=null,k=g.length-2;k>=-1;k--)if((p=t.__resolve({key:o,dataroot:g[k],setNewValue:a,mustMatchFirstKey:!0,_expandStringParams:f})).found)return l(p.value);break;case t._linkMarks.siblings:case t._linkMarks.root:var c;if(u.type===t._linkMarks.siblings){var h=s.split(t._keysSplit);h.length>=2?(h.splice(h.length-1,1,u.key),c=h.join(t._keysSplit)):c=o}else c=o;if((p=t.__resolve({key:c,_expandStringParams:f})).found)return l(p.value)}return""})))),p.functions&&"string"==typeof c&&(c=t.__applyFunctions(c,p.functions)),{found:!h,value:c}}};module.exports=_dataAliases;
